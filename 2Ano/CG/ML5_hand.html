<html>

<head>
    <meta charset="UTF-8">
    <title>BodyPix with Webcam</title>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js" type="text/javascript"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        canvas {
            border: 2px solid rgb(255, 255, 0);
        }

        video {
            display: none;
        }
    </style>
</head>

<body>
    <video id="video" width="640" height="480" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <script>

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const W = canvas.width;
        const H = canvas.height;

        let handpose;
        let hands = [];

        async function preload() {
            // get the video
            video = await getVideo();

            // load the model
            handPose = await ml5.handPose({ flipped: true });

            // start detecting hands from the webcam video
            await handPose.detectStart(video, gotHands);

            // start the animation loop
            render();
        }
        // wait for the DOM to load
        window.addEventListener('DOMContentLoaded', function () {
            preload();
        });

        // This function is called every time ther is an update from the model
        function gotHands(results) {
            // Save the output to the hands variable
            hands = results;
            //console.log(hands);
        }

        let circleX = W / 2;
        let circleY = H / 2;
        let smoothing = 0.2; // Adjust this value for more or less smoothing

        function render() {

            // mirror the video
            ctx.save();
            ctx.translate(W, 0);
            ctx.scale(-1, 1);
            // draw the captured video (optional if you want to see the video in the canvas)
            ctx.drawImage(video, 0, 0, W, H);
            ctx.restore();

            // semi-transparent white overlay
            ctx.fillStyle = "rgba(255,255,255,0.5)";
            ctx.fillRect(0, 0, W, H);


            //  Update rectangle position based on hand detection
            if (hands.length > 0) {
                let hand = hands[0];
                // Index finger tip = keypoint 8
                let indexFingerTip = hand.index_finger_tip;

                // Draw a circle at the fingertip
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(indexFingerTip.x, indexFingerTip.y, 10, 0, 2 * Math.PI);
                ctx.fill();

                // Smoothly interpolate the circle's position towards the index finger tip
                circleX += (indexFingerTip.x - circleX) * smoothing;
                circleY += (indexFingerTip.y - circleY) * smoothing;
            }

            // always draw the circle at its new interpolated position
            ctx.fillStyle = "blue";
            ctx.beginPath();
            ctx.arc(circleX, circleY, 5, 0, 2 * Math.PI);
            ctx.fill();

            requestAnimationFrame(render);
        }

        // Helper Functions
        async function getVideo() {
            const videoElement = document.getElementById('video');
            videoElement.width = W;
            videoElement.height = H;

            // Create a webcam capture
            const capture = await navigator.mediaDevices.getUserMedia({ video: true })
            videoElement.srcObject = capture;
            videoElement.play();

            return videoElement
        }

    </script>
</body>

</html>